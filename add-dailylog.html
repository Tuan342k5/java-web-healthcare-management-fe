<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personal Health Tracker - Add Daily Log</title>
  <link rel="stylesheet" href="css/main-styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
</head>
<body>
  <div class="app-container">
      <!-- Top Header with Contact Info -->
      <div class="top-header">
          <div class="contact-info">
        <span id="user-phone" class="phone">Đang tải...</span>
        <span id="user-email" class="email">Đang tải...</span>
          </div>
      </div>  

      <!-- Main Header -->
      <nav class="navbar navbar-expand-lg main-header">
        <div class="container-fluid header-content">
          <!-- Logo -->
          <a class="navbar-brand logo-placeholder" href="#">
            <img src="imgs/healthcare_logo(2).png" />
          </a>

          <!-- Hamburger button -->
          <button
            class="navbar-toggler menu-toggle"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#mainNav"
            aria-controls="mainNav"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>

          <!-- Menu -->
<div class="collapse navbar-collapse main-nav" id="mainNav">
  <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
    
    <li class="nav-item">
      <a class="nav-link nav-btn" href="main-page.html">Home</a>
    </li>

    <li class="nav-item">
      <a class="nav-link nav-btn" href="records.html">Progress Records</a>
    </li>

    <!-- My Targets Dropdown -->
    <li class="nav-item dropdown">
      <a class="nav-link dropdown-btn" href="#" id="targetsDropdown" role="button"
         data-bs-toggle="dropdown" aria-expanded="false">
        My Targets <i class="fas fa-chevron-down dropdown-icon"></i>
      </a>
      <ul class="dropdown-menu" aria-labelledby="targetsDropdown">
        <li><a class="dropdown-item" href="my-targets.html">Show My Targets</a></li>
        <li><hr class="dropdown-divider" /></li>
        <li><a class="dropdown-item" href="add-target.html">Add New Target</a></li>
      </ul>
    </li>

    <!-- Daily Logs Dropdown -->
    <li class="nav-item dropdown">
      <a class="nav-link dropdown-btn" href="#" id="logsDropdown" role="button"
         data-bs-toggle="dropdown" aria-expanded="false">
        Daily Logs <i class="fas fa-chevron-down dropdown-icon"></i>
      </a>
      <ul class="dropdown-menu" aria-labelledby="logsDropdown">
        <li><a class="dropdown-item" href="my-dailylogs.html">Show Daily Logs</a></li>
        <li><hr class="dropdown-divider" /></li>
        <li><a class="dropdown-item" href="add-dailylog.html">Add New Daily Log</a></li>
      </ul>
    </li>

    <!-- User Account Dropdown (Sửa lại giống các dropdown khác) -->
    <li class="nav-item dropdown">
      <a class="nav-link dropdown-btn" href="#" id="userAccountDropdown" role="button"
         data-bs-toggle="dropdown" aria-expanded="false">
        Hello, <span id="current-user-name">Guest</span>!
        <i class="fas fa-chevron-down dropdown-icon"></i>
      </a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userAccountDropdown">
        <li><hr class="dropdown-divider" /></li>
        <li><a class="dropdown-item" href="login.html">Logout</a></li>
      </ul>
    </li>

  </ul>
</div>
      </nav>

      <!-- Hero Section -->
      <section class="hero-section">
          <div class="hero-content">
              <div class="hero-graphics">
                  <div class="hero-shape-1"></div>
                  <div class="hero-shape-2"></div>
              </div>
              <div class="hero-text">
                  <h1>Add New Daily Log</h1>
                  <p>Record your daily health metrics</p>
              </div>
          </div>
      </section>

      <!-- Main Content -->
      <main class="main-content">
          <!-- Add Daily Log View -->
          <div id="add-daily-log-view" class="content-view active">
              <div class="form-container">
                  <h2>Daily Health Certificate</h2>
                  <form id="dailyLogForm">
                      <div class="form-row">
                          <div class="form-group">
                              <label for="logDate">Date</label>
                              <input type="date" id="logDate" required>
                          </div>
                          <div class="form-group">
                              <label for="logTime">Time</label>
                              <input type="time" id="logTime" required>
                          </div>
                      </div>

                      <hr class="my-4">

                      <div class="row">
                          <div class="col-md-6">
                              <div class="form-group">
                                  <label for="weightValue">Weight (kg)</label>
                                  <input type="number" id="weightValue" step="0.1" placeholder="e.g., 70.5">
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="form-group">
                                  <label for="heightValue">Height (cm)</label>
                                  <input type="number" id="heightValue" step="0.1" placeholder="e.g., 175.0">
                              </div>
                          </div>
                      </div>

                      <div class="row">
                          <div class="col-md-6">
                              <div class="form-group">
                                  <label for="stepsValue">Steps</label>
                                  <input type="number" id="stepsValue" placeholder="e.g., 8500">
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="form-group">
                                  <label for="heartRateValue">Heart Rate (bpm)</label>
                                  <input type="number" id="heartRateValue" placeholder="e.g., 72">
                              </div>
                          </div>
                      </div>

                      <div class="row">
                          <div class="col-md-6">
                              <div class="form-group">
                                  <label for="bloodPressure">Blood Pressure</label>
                                  <input type="text" id="bloodPressure" placeholder="e.g., 120/80">
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="form-group">
                                  <label for="exerciseTime">Exercise Time</label>
                                  <input type="number" id="exerciseTime" placeholder="e.g., 120">
                              </div>
                          </div>
                      </div>

                      <div class="row">
                          <div class="col-md-6">
                              <div class="form-group">
                                  <label for="bloodSugarValue">Blood Sugar (mg/dL)</label>
                                  <input type="number" id="bloodSugarValue" step="0.1" placeholder="e.g., 95.0">
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="form-group">
                                  <label for="sleepValue">Sleep (hours)</label>
                                  <input type="number" id="sleepValue" step="0.1" placeholder="e.g., 7.5">
                              </div>
                          </div>
                      </div>

                      <div class="form-group">
                          <label for="notes">Notes (Optional)</label>
                          <textarea id="notes" rows="3" placeholder="Any additional notes..."></textarea>
                      </div>

                      <div class="form-actions">
                          <button type="button" class="btn-secondary" onclick="window.location.href='main-page.html'">Cancel</button>
                          <button type="submit" class="btn-primary">Save Daily Log</button>
                      </div>
                  </form>
              </div>
          </div>
      </main>

      <!-- Footer with Action Buttons -->
      <footer class="bg-light border-top mt-5 py-4">
        <div class="container">
          <div class="row align-items-center">
            <div class="col-md-6">
              <p class="mb-0 text-muted">&copy; 2025 Health Tracker App. All rights reserved.</p>
              <p class="mb-0">
                <a href="#" class="text-primary text-decoration-none me-3">Privacy Policy</a>
                <a href="#" class="text-primary text-decoration-none">Terms of Service</a>
              </p>
            </div>
            <div class="col-md-6 text-md-end mt-3 mt-md-0">
              <div class="btn-group" role="group">
                <button class="btn btn-outline-primary" onclick="generateReport()" title="Generate comprehensive health report">
                  <i class="fas fa-file-alt me-2"></i>Generate Report
                </button>
                <button class="btn btn-outline-success" onclick="exportData()" title="Export all health data as JSON">
                  <i class="fas fa-download me-2"></i>Export Data
                </button>
                <button class="btn btn-outline-danger" onclick="resetAllData()" title="Reset all data and generate new demo data">
                  <i class="fas fa-refresh me-2"></i>Reset Data
                </button>
              </div>
            </div>
          </div>
        </div>
      </footer>
  </div>
<script>
  function parseJwt(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
  }

  document.getElementById("dailyLogForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const date = document.getElementById("logDate").value;
    const notes = document.getElementById("notes").value;

    // Lấy token từ localStorage
    const token = localStorage.getItem("jwtToken");

    // Kiểm tra nếu chưa đăng nhập thì chuyển về login.html
    if (!token) {
      alert("Bạn chưa đăng nhập!");
      window.location.href = "login.html";
      return;
    }

    // Parse token để lấy userId
    const payload = parseJwt(token);
    const userId = payload.userId || payload.id || payload.sub;

    console.log("User ID từ JWT Token:", userId); // ✅ In ra userId

    const metrics = [
      { metricId: 1, value: document.getElementById("weightValue").value },
      { metricId: 2, value: document.getElementById("heightValue").value },
      { metricId: 3, value: document.getElementById("stepsValue").value },
      { metricId: 4, value: document.getElementById("heartRateValue").value },
      { metricId: 5, value: document.getElementById("bloodPressure").value },
      { metricId: 6, value: document.getElementById("exerciseTime").value },
      { metricId: 7, value: document.getElementById("bloodSugarValue").value },
      { metricId: 8, value: document.getElementById("sleepValue").value }
    ].filter(metric => metric.value);

    const payloadBody = {
      userId: userId,
      date: date,
      notes: notes,
      metrics: metrics
    };

    try {
      const response = await fetch("http://localhost:8286/api/healthrecords", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(payloadBody)
      });

      if (response.ok) {
        alert("Đã lưu nhật ký sức khỏe thành công!");
        window.location.href = "my-dailylogs.html";
      } else {
        const errorText = await response.text();
        console.error("Lỗi khi lưu:", errorText);
        alert("Lỗi khi lưu dữ liệu: " + errorText);
      }
    } catch (error) {
      console.error("Exception:", error);
      alert("Lỗi kết nối đến server!");
    }
  });
</script>
<script type="module">
  import { loadCurrentUserData } from './js/user-info.js';

  document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("jwtToken");
    await loadCurrentUserData(token);

    // Có thể tiếp tục xử lý thêm ở đây...
  });
</script>
</body>
</html>